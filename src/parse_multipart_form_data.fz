module parse_multipart_form_data(data String, boundary String) lock_free.map String String =>

  # Convert boundary to Fuzion-friendly format
  end_boundary := boundary + "--"
  # Initialize form data map
  form_data := (lock_free.map String String).empty
  lines := data.split "\r\n"
  i := mut 0
  while i.get < lines.count do
    line := lines[i].trim
    if line = boundary
      # Start of a new part
      v := values
      i <- i.get + 1
      if i.get < lines.count

        # Read headers
        while i.get < lines.count && (lines[i].find ":").exists do
          l := lines[i].trim
          if l != ""
            v.add l
          i <- i.get+1
        cd := v.get "Content-Disposition"

        if i.get < lines.count
          valueStr :=
            for res := "", res + new_val
            while i.get < lines.count && lines[i] != boundary && lines[i] != end_boundary
            do
              new_val := (res.is_empty ? "" : "") + lines[i]
              i <- i.get + 1
          name := cd._parameters["name"].as_string
          if name != ""
            form_data.add(name, valueStr)

    else if line = end_boundary
      # End of multipart data
      i <- lines.count
    else
      i <- i.get + 1
  form_data

# **************this example extracted from actual running fuzion webserver**************

post_data:="-----------------------------419873511710485736272313445290\r\nContent-Disposition: form-data; name=\"page\"\r\n/index\r\n/index1\r\n-----------------------------419873511710485736272313445290\r\nContent-Disposition: form-data; name=\"sessionid\"\r\n3n_mT-xpNB7wx6YcmyFVmQ\r\n-----------------------------419873511710485736272313445290--"
content_type_boundary:= "-----------------------------419873511710485736272313445290"

say (parse_multipart_form_data post_data content_type_boundary)
